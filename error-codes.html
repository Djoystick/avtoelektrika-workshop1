<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ –æ—à–∏–±–∫–∞–º - –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫–∞</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1 class="logo">‚ö° –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫–∞</h1>
                <p class="tagline">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∏ —Ä–µ–º–æ–Ω—Ç—É</p>
                <nav class="main-nav">
                    <a href="./" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="./vehicles.html" class="nav-link">üöó –ü–æ –º–∞—Ä–∫–∞–º</a>
                    <a href="./error-codes.html" class="nav-link active">üíª –ü–æ –æ—à–∏–±–∫–∞–º</a>
                    <a href="./my-car.html" class="nav-link">üì± –ú–æ–µ –∞–≤—Ç–æ</a>
                </nav>
            </div>
        </header>

        <section class="page-content">
            <h2>üíª –†–µ—à–µ–Ω–∏—è –ø–æ –∫–æ–¥–∞–º –æ—à–∏–±–æ–∫</h2>
            
            <div class="search-box">
                <input id="code-search" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –æ—à–∏–±–∫–∏ (P0300, C0040 –∏ —Ç.–¥.)" class="dtc-input">
                <button onclick="searchCodes()" class="btn btn-primary">–ù–∞–π—Ç–∏</button>
            </div>
            
            <div id="codes-list" class="codes-grid"></div>
            <div id="search-results" class="articles-grid hidden"></div>
        </section>
    </div>

    <footer class="footer">
        <p>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="last-update">–∑–∞–≥—Ä—É–∑–∫–∞...</span></p>
        <p>ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç</p>
    </footer>

    <script src="./utils.js"></script>
    <script src="./db-manager.js"></script>
    <script>
        let db;
        
        document.addEventListener('DOMContentLoaded', async () => {
            db = new DatabaseManager();
            await db.init();
            
            document.getElementById('last-update').textContent = 
                new Date(db.db.lastUpdated).toLocaleString('ru-RU');
            
            const codes = db._getUniqueErrorCodes();
            const codesList = document.getElementById('codes-list');
            
            if (codes.length === 0) {
                codesList.innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫</p>';
                return;
            }
            
            codesList.innerHTML = codes.slice(0, 12).map(code => `
                <div class="code-card">
                    <h3>üíª ${code}</h3>
                    <p>${db.searchByErrorCode(code).length} —Ä–µ—à–µ–Ω–∏–π</p>
                    <button onclick="filterByCode('${code}')" class="btn btn-small">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                </div>
            `).join('');
        });
        
        function searchCodes() {
            const code = document.getElementById('code-search').value.toUpperCase().trim();
            
            if (!code) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –æ—à–∏–±–∫–∏');
                return;
            }
            
            const results = db.searchByErrorCode(code);
            const codesList = document.getElementById('codes-list');
            const searchResults = document.getElementById('search-results');
            
            if (results.length === 0) {
                alert(`–†–µ—à–µ–Ω–∏–π –¥–ª—è –∫–æ–¥–∞ ${code} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`);
                return;
            }
            
            codesList.classList.add('hidden');
            searchResults.classList.remove('hidden');
            
            searchResults.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button onclick="goBack()" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</button>
                    <h3>üíª –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–¥–∞ ${code}</h3>
                </div>
                ${results.map(r => `
                    <div class="article-card">
                        ${r.image ? `<img src="${r.image}" alt="">` : ''}
                        <h4>${r.title}</h4>
                        <p class="meta">${r.contentType} ‚Ä¢ ${r.source}</p>
                        <p>${r.summary.substring(0, 150)}...</p>
                        <a href="${r.link}" target="_blank" class="btn-read">–ß–∏—Ç–∞—Ç—å</a>
                    </div>
                `).join('')}
            `;
        }
        
        function filterByCode(code) {
            document.getElementById('code-search').value = code;
            searchCodes();
        }
        
        function goBack() {
            document.getElementById('codes-list').classList.remove('hidden');
            document.getElementById('search-results').classList.add('hidden');
        }
    </script>
</body>
</html>