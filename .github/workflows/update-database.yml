name: "ğŸš€ Update Real Database: YouTube + Habr + Forums + Community"

on:
  schedule:
    - cron: "0 */6 * * *"  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 6 Ñ‡Ğ°ÑĞ¾Ğ² (00:00, 06:00, 12:00, 18:00 UTC)
  workflow_dispatch:        # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

jobs:
  update-db:
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v3
      
      - name: "ğŸ Set up Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: "ğŸ“¦ Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install feedparser requests beautifulsoup4
      
      - name: "ğŸ¬ Parse YouTube Videos"
        run: |
          echo "ğŸ¬ YouTube Parser..."
          python scripts/parse_youtube.py
        continue-on-error: true
      
      - name: "ğŸ“š Parse Habr Articles"
        run: |
          echo "ğŸ“š Habr Parser..."
          python scripts/parse_habr.py
        continue-on-error: true
      
      - name: "ğŸ’¬ Parse Forums (RSS)"
        run: |
          echo "ğŸ’¬ Forums RSS Parser..."
          python scripts/parse_forums_rss.py
        continue-on-error: true
      
      - name: "ğŸ’¬ Parse Forums (HTML)"
        run: |
          echo "ğŸ’¬ Forums HTML Parser..."
          python scripts/parse_forums_html.py
        continue-on-error: true
      
      - name: "ğŸ”§ Build Final Database"
        run: |
          echo "ğŸ”§ Building database..."
          python scripts/build_db.py
      
      - name: "ğŸ“Š Show Statistics"
        run: |
          echo "ğŸ“Š Database Statistics:"
          python -c "
import json
try:
    data = json.load(open('db.json'))
    stats = data.get('stats', {})
    print(f\"âœ… Total Articles: {stats.get('totalArticles', 0)}\")
    print(f\"   ğŸ¬ YouTube: {stats.get('youtube', 0)}\")
    print(f\"   ğŸ“š Habr: {stats.get('habr', 0)}\")
    print(f\"   ğŸ’¬ Forums: {stats.get('forums', 0)}\")
    print(f\"   ğŸ¤ Community: {stats.get('community', 0)}\")
except Exception as e:
    print(f\"âŒ Error: {e}\")
          "
      
      - name: "ğŸ”„ Commit & Push Changes"
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "ğŸ¤– Database Bot"
          git add db.json api-cache/
          git diff --cached --exit-code || (
            git commit -m "ğŸ¤– Auto-update: $(date +'%Y-%m-%d %H:%M:%S UTC') | YouTube + Habr + Forums + Community"
            git push
          )
        continue-on-error: true
      
      - name: "âœ… Update Complete"
        run: echo "âœ… Database update completed at $(date +'%Y-%m-%d %H:%M:%S UTC')"
